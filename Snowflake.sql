ALTER ACCOUNT SET CORTEX_ENABLED_CROSS_REGION = 'ANY_REGION';
-- create the database
CREATE OR REPLACE DATABASE BRAZE_ENGAGEMENT;

-- create the schema
CREATE SCHEMA BRAZE_ENGAGEMENT.EMAIL_DATA;

-- switch to database and schema that was created
USE DATABASE BRAZE_ENGAGEMENT;
USE SCHEMA EMAIL_DATA;

-- create stage for raw data
CREATE OR REPLACE STAGE EMAIL_STAGE DIRECTORY = (ENABLE = TRUE);
-- create the table to hold our changelog data
CREATE OR REPLACE TABLE CAMPAIGN_CHANGELOGS (
    ID VARCHAR(16777216),
	TIME NUMBER(38,0),
	APP_GROUP_ID VARCHAR(16777216),
	API_ID VARCHAR(16777216) PRIMARY KEY,  -- Primary key for relationships
	NAME VARCHAR(16777216),
	CONVERSION_BEHAVIORS ARRAY,
	ACTIONS ARRAY
);

-- create the table to hold our email send data
CREATE OR REPLACE TABLE EMAIL_SENDS (
    ID VARCHAR(16777216) PRIMARY KEY,  -- Primary key
	USER_ID VARCHAR(16777216),
	EXTERNAL_USER_ID VARCHAR(16777216),
	DEVICE_ID VARCHAR(16777216),
	APP_GROUP_ID VARCHAR(16777216),
	APP_GROUP_API_ID VARCHAR(16777216),
	TIME TIMESTAMP_LTZ(9),
	DISPATCH_ID VARCHAR(16777216),
	SEND_ID VARCHAR(16777216),
	CAMPAIGN_ID VARCHAR(16777216),
	CAMPAIGN_API_ID VARCHAR(16777216),
	MESSAGE_VARIATION_API_ID VARCHAR(16777216),
	CANVAS_ID VARCHAR(16777216),
	CANVAS_API_ID VARCHAR(16777216),
	CANVAS_VARIATION_API_ID VARCHAR(16777216),
	CANVAS_STEP_API_ID VARCHAR(16777216),
	CANVAS_STEP_MESSAGE_VARIATION_API_ID VARCHAR(16777216),
	GENDER VARCHAR(16777216),
	COUNTRY VARCHAR(16777216),
	TIMEZONE VARCHAR(16777216),
	LANGUAGE VARCHAR(16777216),
	EMAIL_ADDRESS VARCHAR(16777216),
	IP_POOL VARCHAR(16777216),
	MESSAGE_EXTRAS VARCHAR(16777216),
	ESP VARCHAR(16777216),
	FROM_DOMAIN VARCHAR(16777216),
	SF_CREATED_AT TIMESTAMP_LTZ(9)
);

-- create the table to hold our email open data
CREATE OR REPLACE TABLE EMAIL_OPENS (
    ID VARCHAR(16777216),
	USER_ID VARCHAR(16777216),
	EXTERNAL_USER_ID VARCHAR(16777216),
	DEVICE_ID VARCHAR(16777216),
	APP_GROUP_ID VARCHAR(16777216),
	APP_GROUP_API_ID VARCHAR(16777216),
	TIME TIMESTAMP_LTZ(9),
	DISPATCH_ID VARCHAR(16777216),
	SEND_ID VARCHAR(16777216),
	CAMPAIGN_ID VARCHAR(16777216),
	CAMPAIGN_API_ID VARCHAR(16777216),
	MESSAGE_VARIATION_API_ID VARCHAR(16777216),
	CANVAS_ID VARCHAR(16777216),
	CANVAS_API_ID VARCHAR(16777216),
	CANVAS_VARIATION_API_ID VARCHAR(16777216),
	CANVAS_STEP_API_ID VARCHAR(16777216),
	CANVAS_STEP_MESSAGE_VARIATION_API_ID VARCHAR(16777216),
	GENDER VARCHAR(16777216),
	COUNTRY VARCHAR(16777216),
	TIMEZONE VARCHAR(16777216),
	LANGUAGE VARCHAR(16777216),
	EMAIL_ADDRESS VARCHAR(16777216),
	USER_AGENT VARCHAR(16777216),
	IP_POOL VARCHAR(16777216),
	MACHINE_OPEN VARCHAR(16777216),
	ESP VARCHAR(16777216),
	FROM_DOMAIN VARCHAR(16777216),
	IS_AMP BOOLEAN,
	SF_CREATED_AT TIMESTAMP_LTZ(9),
	-- Compound primary key for one-to-one relationships
	PRIMARY KEY (DISPATCH_ID, EXTERNAL_USER_ID)
);

-- create the table to hold our email click
CREATE OR REPLACE TABLE EMAIL_CLICKS (
    ID VARCHAR(16777216),
	USER_ID VARCHAR(16777216),
	EXTERNAL_USER_ID VARCHAR(16777216),
	DEVICE_ID VARCHAR(16777216),
	APP_GROUP_ID VARCHAR(16777216),
	APP_GROUP_API_ID VARCHAR(16777216),
	TIME TIMESTAMP_LTZ(9),
	DISPATCH_ID VARCHAR(16777216),
	SEND_ID VARCHAR(16777216),
	CAMPAIGN_ID VARCHAR(16777216),
	CAMPAIGN_API_ID VARCHAR(16777216),
	MESSAGE_VARIATION_API_ID VARCHAR(16777216),
	CANVAS_ID VARCHAR(16777216),
	CANVAS_API_ID VARCHAR(16777216),
	CANVAS_VARIATION_API_ID VARCHAR(16777216),
	CANVAS_STEP_API_ID VARCHAR(16777216),
	CANVAS_STEP_MESSAGE_VARIATION_API_ID VARCHAR(16777216),
	GENDER VARCHAR(16777216),
	COUNTRY VARCHAR(16777216),
	TIMEZONE VARCHAR(16777216),
	LANGUAGE VARCHAR(16777216),
	EMAIL_ADDRESS VARCHAR(16777216),
    URL VARCHAR(16777216),
	USER_AGENT VARCHAR(16777216),
	IP_POOL VARCHAR(16777216),
    LINK_ID VARCHAR(16777216),
	LINK_ALIAS VARCHAR(16777216),
	MACHINE_OPEN VARCHAR(16777216),
	ESP VARCHAR(16777216),
	FROM_DOMAIN VARCHAR(16777216),
	IS_AMP BOOLEAN,
	SF_CREATED_AT TIMESTAMP_LTZ(9),
	-- Compound primary key for one-to-one relationships
	PRIMARY KEY (DISPATCH_ID, EXTERNAL_USER_ID)
);

-- create the table to hold our email unsubscribe data
CREATE OR REPLACE TABLE EMAIL_UNSUBSCRIBES (
    ID VARCHAR(16777216),
	USER_ID VARCHAR(16777216),
	EXTERNAL_USER_ID VARCHAR(16777216),
	DEVICE_ID VARCHAR(16777216),
	APP_GROUP_ID VARCHAR(16777216),
	APP_GROUP_API_ID VARCHAR(16777216),
	TIME TIMESTAMP_LTZ(9),
	DISPATCH_ID VARCHAR(16777216),
	SEND_ID VARCHAR(16777216),
	CAMPAIGN_ID VARCHAR(16777216),
	CAMPAIGN_API_ID VARCHAR(16777216),
	MESSAGE_VARIATION_API_ID VARCHAR(16777216),
	CANVAS_ID VARCHAR(16777216),
	CANVAS_API_ID VARCHAR(16777216),
	CANVAS_VARIATION_API_ID VARCHAR(16777216),
	CANVAS_STEP_API_ID VARCHAR(16777216),
	CANVAS_STEP_MESSAGE_VARIATION_API_ID VARCHAR(16777216),
	GENDER VARCHAR(16777216),
	COUNTRY VARCHAR(16777216),
	TIMEZONE VARCHAR(16777216),
	LANGUAGE VARCHAR(16777216),
	EMAIL_ADDRESS VARCHAR(16777216),
	IP_POOL VARCHAR(16777216),
	SF_CREATED_AT TIMESTAMP_LTZ(9),
	-- Compound primary key for one-to-one relationships
	PRIMARY KEY (DISPATCH_ID, EXTERNAL_USER_ID)
);
-- load data into changelog 
COPY INTO "BRAZE_ENGAGEMENT"."EMAIL_DATA"."CAMPAIGN_CHANGELOGS"
FROM (
    SELECT $1, $2, $3, $4, $5, $6, $7
    FROM '@"BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_STAGE"'
)
FILES = ('CHANGELOGS_CAMPAIGN_VIEW.csv')
FILE_FORMAT = (
    TYPE=CSV,
    SKIP_HEADER=1,
    FIELD_DELIMITER=',',
    TRIM_SPACE=TRUE,
    FIELD_OPTIONALLY_ENCLOSED_BY='"',
    REPLACE_INVALID_CHARACTERS=TRUE,
    DATE_FORMAT=AUTO,
    TIME_FORMAT=AUTO,
    TIMESTAMP_FORMAT=AUTO
)
ON_ERROR=ABORT_STATEMENT;

-- load data into email sends tables
COPY INTO "BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_SENDS"
FROM (
    SELECT $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27
    FROM '@"BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_STAGE"'
)
FILES = ('USERS_MESSAGES_EMAIL_SEND_VIEW.csv')
FILE_FORMAT = (
    TYPE=CSV,
    SKIP_HEADER=1,
    FIELD_DELIMITER=',',
    TRIM_SPACE=TRUE,
    FIELD_OPTIONALLY_ENCLOSED_BY='"',
    REPLACE_INVALID_CHARACTERS=TRUE,
    DATE_FORMAT=AUTO,
    TIME_FORMAT=AUTO,
    TIMESTAMP_FORMAT=AUTO
)
ON_ERROR=ABORT_STATEMENT;

-- load data into email opens tables
COPY INTO "BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_OPENS"
FROM (
    SELECT $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29
    FROM '@"BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_STAGE"'
)
FILES = ('USERS_MESSAGES_EMAIL_OPEN_VIEW.csv')
FILE_FORMAT = (
    TYPE=CSV,
    SKIP_HEADER=1,
    FIELD_DELIMITER=',',
    TRIM_SPACE=TRUE,
    FIELD_OPTIONALLY_ENCLOSED_BY='"',
    REPLACE_INVALID_CHARACTERS=TRUE,
    DATE_FORMAT=AUTO,
    TIME_FORMAT=AUTO,
    TIMESTAMP_FORMAT=AUTO
)
ON_ERROR=ABORT_STATEMENT;

-- load data into email clicks tables
COPY INTO "BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_CLICKS"
FROM (
    SELECT $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, null, $28, $29, $30, $31
    FROM '@"BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_STAGE"'
)
FILES = ('USERS_MESSAGES_EMAIL_CLICK_VIEW.csv')
FILE_FORMAT = (
    TYPE=CSV,
    SKIP_HEADER=1,
    FIELD_DELIMITER=',',
    TRIM_SPACE=TRUE,
    FIELD_OPTIONALLY_ENCLOSED_BY='"',
    REPLACE_INVALID_CHARACTERS=TRUE,
    DATE_FORMAT=AUTO,
    TIME_FORMAT=AUTO,
    TIMESTAMP_FORMAT=AUTO
)
ON_ERROR=ABORT_STATEMENT;

-- load data into email unsubscribes tables
COPY INTO "BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_UNSUBSCRIBES"
FROM (
    SELECT $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24
    FROM '@"BRAZE_ENGAGEMENT"."EMAIL_DATA"."EMAIL_STAGE"'
)
FILES = ('USERS_MESSAGES_EMAIL_UNSUBSCRIBE_VIEW.csv')
FILE_FORMAT = (
    TYPE=CSV,
    SKIP_HEADER=1,
    FIELD_DELIMITER=',',
    TRIM_SPACE=TRUE,
    FIELD_OPTIONALLY_ENCLOSED_BY='"',
    REPLACE_INVALID_CHARACTERS=TRUE,
    DATE_FORMAT=AUTO,
    TIME_FORMAT=AUTO,
    TIMESTAMP_FORMAT=AUTO
)
ON_ERROR=ABORT_STATEMENT;
-- view changelog table data
SELECT *
FROM BRAZE_ENGAGEMENT.EMAIL_DATA.CAMPAIGN_CHANGELOGS
LIMIT 10;
-- view email sends data
SELECT *
FROM BRAZE_ENGAGEMENT.EMAIL_DATA.EMAIL_SENDS
LIMIT 10;
-- view email open data
SELECT *
FROM BRAZE_ENGAGEMENT.EMAIL_DATA.EMAIL_OPENS
LIMIT 10;
-- view email click data
SELECT *
FROM BRAZE_ENGAGEMENT.EMAIL_DATA.EMAIL_CLICKS
LIMIT 10;
-- view email unsubscribes data
SELECT *
FROM BRAZE_ENGAGEMENT.EMAIL_DATA.EMAIL_UNSUBSCRIBES
LIMIT 10;
